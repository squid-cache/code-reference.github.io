<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Squid Web Cache: Callback Data Allocator API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Squid Web Cache<span id="projectnumber">&#160;master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('CBDATA.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Callback Data Allocator API</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="CbDataIntro"></a>
Introduction</h1>
<dl class="section user"><dt></dt><dd>Squid's extensive use of callback functions makes it very susceptible to memory access errors. To address this all callback functions make use of a construct called cbdata. This allows functions doing callbacks to verify that the caller is still valid before making the callback.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>cbdata is intended for callback data and is tailored specifically to make callbacks less dangerous leaving as few windows of errors as possible. It is not suitable or intended as a generic <a class="el" href="classRefCount.html">RefCount</a> memory allocator.</dd></dl>
<dl class="section user"><dt></dt><dd>The AsyncJob/AsyncCall mechanism is preferred over CBDATA. It replaces cbdata with an <a class="el" href="classAsyncCall.html#a57c571a47666d10c316689dc5d09e170">AsyncCall::Pointer</a> object which performs the same memory protection duties via other means.</dd></dl>
<h1><a class="anchor" id="Examples"></a>
Examples</h1>
<dl class="section user"><dt></dt><dd>Here you can find some examples on how to use cbdata, and why.</dd></dl>
<h2><a class="anchor" id="AsyncOpWithoutCBDATA"></a>
Asynchronous operation without cbdata, showing why cbdata is needed</h2>
<dl class="section user"><dt></dt><dd>For a asynchronous operation with callback functions, the normal sequence of events in programs NOT using cbdata is as follows:</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// initialization</span></div>
<div class="line">type_of_data our_data = <span class="keyword">new</span> ...;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Initiate a asynchronous operation, with our_data as callback_data</span></div>
<div class="line">fooOperationStart(bar, callback_func, our_data);</div>
<div class="line">...</div>
<div class="line"><span class="comment">// The asynchronous operation completes and makes the callback</span></div>
<div class="line">callback_func(callback_data, ....);</div>
<div class="line"><span class="comment">// Some time later we clean up our data</span></div>
<div class="line"><span class="keyword">delete</span> our_data;</div>
</div><!-- fragment --><dl class="section user"><dt></dt><dd>However, things become more interesting if we want or need to free the callback_data, or otherwise cancel the callback, before the operation completes. In constructs like this you can quite easily end up with having the memory referenced pointed to by callback_data freed before the callback is invoked causing a program failure or memory corruption:</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// initialization</span></div>
<div class="line">type_of_data our_data = <span class="keyword">new</span> ...;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Initiate a asynchronous operation, with our_data as callback_data</span></div>
<div class="line">fooOperationStart(bar, callback_func, our_data);</div>
<div class="line">...</div>
<div class="line"><span class="comment">// ouch, something bad happened elsewhere.. try to cleanup</span></div>
<div class="line"><span class="comment">// but the programmer forgot there is a callback pending from</span></div>
<div class="line"><span class="comment">// fooOperationsStart(). An easy thing to forget when writing code</span></div>
<div class="line"><span class="comment">// to deal with errors, especially if there may be many different</span></div>
<div class="line"><span class="comment">// pending operations.</span></div>
<div class="line">delete our_data;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// The asynchronous operation completes and makes the callback</span></div>
<div class="line">callback_func(callback_data, ....);</div>
<div class="line"><span class="comment">// CRASH, the memory pointer to by callback_data is no longer valid</span></div>
<div class="line"><span class="comment">// at the time of the callback</span></div>
</div><!-- fragment --><h2><a class="anchor" id="AsyncOpWithCBDATA"></a>
Asynchronous operation with cbdata</h2>
<dl class="section user"><dt></dt><dd>The callback data allocator lets us do this in a uniform and safe manner. The callback data allocator is used to allocate, track and free memory pool objects used during callback operations. Allocated memory is locked while the asynchronous operation executes elsewhere, and is freed when the operation completes. The normal sequence of events is:</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// initialization</span></div>
<div class="line">type_of_data our_data = <span class="keyword">new</span> type_of_data;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Initiate a asynchronous operation, with our_data as callback_data</span></div>
<div class="line">fooOperationStart(..., callback_func, our_data);</div>
<div class="line">...</div>
<div class="line"><span class="comment">// foo</span></div>
<div class="line">void *local_pointer = <a class="code hl_define" href="cbdata_8h.html#a23338dbb451f460facd39a8a249bab46">cbdataReference</a>(callback_data);</div>
<div class="line">....</div>
<div class="line"><span class="comment">// The asynchronous operation completes and makes the callback</span></div>
<div class="line"><span class="keywordtype">void</span> *<a class="code hl_class" href="classcbdata.html">cbdata</a>;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_define" href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone</a>(local_pointer, &amp;amp;<a class="code hl_class" href="classcbdata.html">cbdata</a>))</div>
<div class="line">    callback_func(...., <a class="code hl_class" href="classcbdata.html">cbdata</a>);</div>
<div class="line"><span class="keyword">delete</span> our_data;</div>
<div class="ttc" id="acbdata_8h_html_a23338dbb451f460facd39a8a249bab46"><div class="ttname"><a href="cbdata_8h.html#a23338dbb451f460facd39a8a249bab46">cbdataReference</a></div><div class="ttdeci">#define cbdataReference(var)</div><div class="ttdef"><b>Definition</b> <a href="cbdata_8h_source.html#l00348">cbdata.h:348</a></div></div>
<div class="ttc" id="acbdata_8h_html_a8a5cb00a2c49df1962e91b4746f79b60"><div class="ttname"><a href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone</a></div><div class="ttdeci">#define cbdataReferenceValidDone(var, ptr)</div><div class="ttdef"><b>Definition</b> <a href="cbdata_8h_source.html#l00239">cbdata.h:239</a></div></div>
<div class="ttc" id="aclasscbdata_html"><div class="ttname"><a href="classcbdata.html">cbdata</a></div><div class="ttdef"><b>Definition</b> <a href="cbdata_8cc_source.html#l00037">cbdata.cc:38</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="AsynchronousOpCancelledByCBDATA"></a>
Asynchronous operation cancelled by cbdata</h2>
<dl class="section user"><dt></dt><dd>With this scheme, nothing bad happens if delete gets called before fooOperantionComplete(...).</dd></dl>
<dl class="section user"><dt>Initialization</dt><dd><div class="fragment"><div class="line"><span class="comment">// initialization</span></div>
<div class="line">type_of_data our_data = <span class="keyword">new</span> type_of_data;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// Initiate a asynchronous operation, with our_data as callback_data</span></div>
<div class="line">fooOperationStart(..., callback_func, our_data);</div>
<div class="line">...</div>
<div class="line"><span class="comment">// do some stuff with it</span></div>
<div class="line">void *local_pointer = <a class="code hl_define" href="cbdata_8h.html#a23338dbb451f460facd39a8a249bab46">cbdataReference</a>(callback_data);</div>
<div class="line">...</div>
<div class="line"><span class="comment">// something bad happened elsewhere.. cleanup</span></div>
<div class="line">delete our_data;</div>
<div class="line">....</div>
<div class="line"><span class="comment">// The asynchronous operation completes and makes the callback</span></div>
<div class="line"><span class="keywordtype">void</span> *<a class="code hl_class" href="classcbdata.html">cbdata</a>;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_define" href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone</a>(local_pointer, &amp;amp;<a class="code hl_class" href="classcbdata.html">cbdata</a>))</div>
<div class="line">    <span class="comment">// won&#39;t be called, as the data is no longer valid</span></div>
<div class="line">    callback_func(...., <a class="code hl_class" href="classcbdata.html">cbdata</a>);</div>
<div class="line"><span class="keyword">delete</span> our_data;</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>In this case, when delete is called before <a class="el" href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone()</a>, the callback_data gets marked as invalid. When the callback_data is invalid before executing the callback function, <a class="el" href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone()</a> will return 0 and callback_func is never executed.</dd></dl>
<h2><a class="anchor" id="AddingCBDATAType"></a>
Adding a new cbdata registered type</h2>
<dl class="section user"><dt></dt><dd>To add new module specific data types to the allocator one uses the macro <a class="el" href="cbdata_8h.html#abfcdfa870c3f1e87ced73a4c5f196168">CBDATA_CLASS()</a> in the class private section, and <a class="el" href="cbdata_8h.html#a4710a3530194cffbc7f74fa2b2c4529d">CBDATA_CLASS_INIT()</a> or <a class="el" href="cbdata_8h.html#ad60a7b19cb747d7868f3b241c67f77b9">CBDATA_NAMESPACED_CLASS_INIT()</a> in the class .cc file.</dd></dl>
<div class="fragment"><div class="line"><span class="keyword">class </span>Foo</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="cbdata_8h.html#abfcdfa870c3f1e87ced73a4c5f196168">CBDATA_CLASS</a>(Foo);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Foo() {}</div>
<div class="line">    ~Foo() {}</div>
<div class="line">};</div>
<div class="line">...</div>
<div class="line">CBDATA_CLASS_INIT(Foo);</div>
<div class="ttc" id="acbdata_8h_html_abfcdfa870c3f1e87ced73a4c5f196168"><div class="ttname"><a href="cbdata_8h.html#abfcdfa870c3f1e87ced73a4c5f196168">CBDATA_CLASS</a></div><div class="ttdeci">#define CBDATA_CLASS(type)</div><div class="ttdef"><b>Definition</b> <a href="cbdata_8h_source.html#l00289">cbdata.h:289</a></div></div>
</div><!-- fragment --><dl class="section user"><dt></dt><dd>These macros create new(), delete() and toCbdata() methods definition in class scope. Any allocate calls must be made with new() and destruction with delete(), they may be called from anywhere.</dd></dl>
<dl class="section user"><dt></dt><dd>The class constructor must make sure that all member variables are initialized, and the class destructor that all dynamic memory is released.</dd></dl>
<dl class="section user"><dt></dt><dd>The CbcPointer&lt;&gt; template should be used to create a smart-pointer type for simple reference tracking. It provides get() and valid() accessors for use instead of <a class="el" href="cbdata_8h.html#aa6ed5c53b844c6f8f3e7c39daa051835">cbdataReferenceValid()</a>, and performs reliable automatic <a class="el" href="cbdata_8h.html#a23338dbb451f460facd39a8a249bab46">cbdataReference()</a> and <a class="el" href="cbdata_8h.html#a178af3acec8011dd955016f69e307037">cbdataReferenceDone()</a> tracking. <a class="el" href="classNote.html">Note</a> that it does NOT provide a replacement for <a class="el" href="cbdata_8h.html#a8a5cb00a2c49df1962e91b4746f79b60">cbdataReferenceValidDone()</a>. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
