<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Squid Web Cache: Rock Store Rebuild</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Squid Web Cache<span id="projectnumber">&#160;master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__RockFsRebuild.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Rock Store Rebuild</div></div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="RockFsRebuildOverview"></a>
Overview</h1>
<p>Several layers of information are manipualted during the rebuild: </p><dl class="section user"><dt></dt><dd><a class="el" href="namespaceStore.html">Store</a> <a class="el" href="classEntry.html">Entry</a>: Response message plus all the metainformation associated with it. Identified by store key. At any given time, from Squid point of view, there is only one entry with a given key, but several different entries with the same key can be observed in any historical archive (such as an access log or a store database). </dd></dl>
<dl class="section user"><dt></dt><dd>Slot chain: A sequence of db slots representing a <a class="el" href="namespaceStore.html">Store</a> <a class="el" href="classEntry.html">Entry</a> state at some point in time. Identified by key+version combination. Due to transaction aborts, crashes, and idle periods, some chains may contain incomplete or stale information. We assume that no two different chains have the same key and version. If that assumption fails, we may serve a hodgepodge entry during rebuild, until "extra" slots are loaded/noticed. </dd></dl>
<dl class="section user"><dt></dt><dd>iNode: The very first db slot in an entry slot chain. This slot contains at least the beginning of <a class="el" href="namespaceStore.html">Store</a> <a class="el" href="classEntry.html">Entry</a> metadata, but most 32KB inodes contain the entire metadata, HTTP headers, and HTTP body. </dd></dl>
<dl class="section user"><dt></dt><dd>Db slot: A db record containing a piece of a single store entry and linked to other slots with the same key and version fields, forming a chain. Slots are identified by their absolute position in the database file, which is naturally unique. </dd></dl>
<dl class="section user"><dt></dt><dd>When information from the newly loaded db slot contradicts the entry-level information collected so far (e.g., the versions do not match or the total chain size after the slot contribution exceeds the expected number), the whole entry (and not just the chain or the slot!) is declared corrupted. </dd></dl>
<dl class="section user"><dt></dt><dd>Why invalidate the whole entry? <a class="el" href="namespaceRock.html">Rock</a> <a class="el" href="namespaceStore.html">Store</a> is written for high-load environments with large caches, where there is usually very few idle slots in the database. A space occupied by a purged entry is usually immediately reclaimed. A Squid crash or a transaction abort is rather unlikely to leave a relatively large number of stale slots in the database. Thus, the number of potentially corrupted entries is relatively small. On the other hand, the damage from serving a single hadgepodge entry may be significant to the user. In such an environment, invalidating the whole entry has negligible performance impact but saves us from high-damage bugs. </dd></dl>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
